"use strict";(()=>{var t={};t.id=567,t.ids=[567],t.modules={399:t=>{t.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:t=>{t.exports=require("buffer")},6113:t=>{t.exports=require("crypto")},2361:t=>{t.exports=require("events")},3685:t=>{t.exports=require("http")},5687:t=>{t.exports=require("https")},1808:t=>{t.exports=require("net")},5477:t=>{t.exports=require("punycode")},2781:t=>{t.exports=require("stream")},4404:t=>{t.exports=require("tls")},7310:t=>{t.exports=require("url")},9796:t=>{t.exports=require("zlib")},1452:(t,e,r)=>{r.r(e),r.d(e,{originalPathname:()=>g,patchFetch:()=>b,requestAsyncStorage:()=>f,routeModule:()=>d,serverHooks:()=>q,staticGenerationAsyncStorage:()=>m});var a={};r.r(a),r.d(a,{GET:()=>c});var s=r(9303),o=r(8716),n=r(670),l=r(7070),i=r(2814);let _=process.env.SUPABASE_URL,u=process.env.SUPABASE_SERVICE_ROLE,p=_&&u?(0,i.eI)(_,u):null;async function c(){try{if(!process.env.SUPABASE_URL||!process.env.SUPABASE_SERVICE_ROLE)return l.NextResponse.json({overview:{total_consignments:0,total_blocks:0,total_expenditure:0,total_sqft_produced:0,avg_cost_per_sqft:0,total_sales:0,total_profit:0,total_sqft_sold:0,profit_margin:0},blocks:{by_status:{},total:0},parts:{},buyers:{top_buyers:[],total_buyers:0},recent_sales:[]});let[t,e,r,a]=await Promise.all([p.from("granite_consignments").select("id, total_expenditure").then(t=>t.error&&t.error.message.includes("does not exist")?{data:[],error:null}:t),p.from("granite_blocks").select("id, status, net_measurement, total_sqft"),p.from("granite_block_parts").select(`
          id,
          part_name,
          sqft,
          sold_sqft,
          remaining_sqft,
          granite_blocks!inner(
            consignment_id,
            granite_consignments!inner(
              total_cost_per_sqft
            )
          )
        `),p.from("granite_sales").select(`
          id,
          buyer_name,
          sqft_sold,
          total_selling_price,
          total_profit,
          sale_date,
          part_name,
          block_no
        `)]);if(t.error)throw t.error;if(e.error)throw e.error;if(r.error)throw r.error;if(a.error)throw a.error;let s=t.data||[],o=e.data||[],n=r.data||[],i=a.data||[],_=s.length,u=o.length,c=s.reduce((t,e)=>t+(e.total_expenditure||0),0),d=s.reduce((t,e)=>t+(e.total_sqft_produced||0),0),f=i.reduce((t,e)=>t+(e.total_selling_price||0),0),m=i.reduce((t,e)=>t+(e.total_profit||0),0),q=i.reduce((t,e)=>t+(e.sqft_sold||0),0),g=o.reduce((t,e)=>(t[e.status]=(t[e.status]||0)+1,t),{}),b=n.reduce((t,e)=>(t[e.part_name]||(t[e.part_name]={total_sqft:0,sold_sqft:0,remaining_sqft:0,count:0}),t[e.part_name].total_sqft+=e.sqft||0,t[e.part_name].sold_sqft+=e.sold_sqft||0,t[e.part_name].remaining_sqft+=e.remaining_sqft||0,t[e.part_name].count+=1,t),{}),y=i.reduce((t,e)=>(t[e.buyer_name]||(t[e.buyer_name]={name:e.buyer_name,sqftPurchased:0,totalAmount:0,totalProfit:0,transactions:0}),t[e.buyer_name].sqftPurchased+=e.sqft_sold||0,t[e.buyer_name].totalAmount+=e.total_selling_price||0,t[e.buyer_name].totalProfit+=e.total_profit||0,t[e.buyer_name].transactions+=1,t),{}),x=Object.values(y).map(t=>({name:t.name,sqftPurchased:t.sqftPurchased,totalProfit:t.totalProfit,avgRate:t.sqftPurchased>0?t.totalAmount/t.sqftPurchased:0,transactions:t.transactions})).sort((t,e)=>e.totalAmount-t.totalAmount).slice(0,5),h=i.sort((t,e)=>new Date(e.sale_date).getTime()-new Date(t.sale_date).getTime()).slice(0,10).map(t=>({id:t.id,buyer:t.buyer_name,blockPart:`${t.block_no}-${t.part_name}`,sqft:t.sqft_sold,rate:t.sqft_sold>0?Math.round(t.total_selling_price/t.sqft_sold):0,profit:t.total_profit,date:new Date(t.sale_date).toLocaleDateString("en-IN")})),v={overview:{total_consignments:_,total_blocks:u,total_expenditure:c,total_sqft_produced:d,avg_cost_per_sqft:d>0?c/d:0,total_sales:f,total_profit:m,total_sqft_sold:q,profit_margin:f>0?m/f*100:0},blocks:{by_status:g,total:u},parts:b,buyers:{top_buyers:x,total_buyers:Object.keys(y).length},recent_sales:h};return l.NextResponse.json(v)}catch(t){return console.error("Error fetching analytics:",t),l.NextResponse.json({error:"Internal server error"},{status:500})}}let d=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/analytics/route",pathname:"/api/analytics",filename:"route",bundlePath:"app/api/analytics/route"},resolvedPagePath:"/Users/bala/Downloads/granite-ledger-1/app/api/analytics/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:m,serverHooks:q}=d,g="/api/analytics/route";function b(){return(0,n.patchFetch)({serverHooks:q,staticGenerationAsyncStorage:m})}}};var e=require("../../../webpack-runtime.js");e.C(t);var r=t=>e(e.s=t),a=e.X(0,[948,505],()=>r(1452));module.exports=a})();