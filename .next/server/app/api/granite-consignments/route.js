"use strict";(()=>{var e={};e.id=354,e.ids=[354],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1808:e=>{e.exports=require("net")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},4404:e=>{e.exports=require("tls")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},9552:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>x,patchFetch:()=>_,requestAsyncStorage:()=>g,routeModule:()=>d,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m});var s={};t.r(s),t.d(s,{DELETE:()=>c,GET:()=>u,POST:()=>l});var n=t(9303),a=t(8716),o=t(670),i=t(7070),p=t(2632);async function u(e){try{let r=new URL(e.url).searchParams.get("id");if(r){let{data:e,error:t}=await p.p.from("granite_consignments").select(`
          *,
          supplier:granite_suppliers(id, name, contact_person),
          blocks:granite_blocks(id, block_no, gross_measurement, net_measurement, elavance, grade, status)
        `).eq("id",r).single();if(t)return i.NextResponse.json({error:t.message},{status:500});return i.NextResponse.json(e)}{let{data:e,error:r}=await p.p.from("granite_consignments").select("*, supplier:granite_suppliers(id, name, contact_person)").order("arrival_date",{ascending:!1});if(r)return i.NextResponse.json({error:r.message},{status:500});return i.NextResponse.json(e)}}catch(e){return i.NextResponse.json({error:"Internal server error"},{status:500})}}async function l(e){try{let r=await e.json(),{consignment_number:t,supplier_id:s,arrival_date:n,payment_cash:a=0,payment_upi:o=0,transport_cost:u=0,notes:l}=r;if(console.log("Creating consignment with data:",r),!t||!s||!n)return i.NextResponse.json({error:"Required fields missing: consignment_number, supplier_id, and arrival_date are required"},{status:400});let{data:c,error:d}=await p.p.from("granite_suppliers").select("id, name").eq("id",s).single();if(d||!c){console.log("Supplier not found, checking for fallback supplier creation");let e=[{id:"supplier-1",name:"Rising Sun Exports",contact_person:"Manager"},{id:"supplier-2",name:"Bargandy Quarry",contact_person:"Sales Head"},{id:"supplier-3",name:"Local Granite Quarry",contact_person:"Owner"}].find(e=>e.id===s);if(!e)return i.NextResponse.json({error:`Supplier with ID ${s} not found. Please select a valid supplier.`},{status:400});{let{data:r,error:t}=await p.p.from("granite_suppliers").upsert({id:e.id,name:e.name,contact_person:e.contact_person}).select().single();if(t)return console.error("Failed to create fallback supplier:",t),i.NextResponse.json({error:`Supplier with ID ${s} not found and could not be created: ${t.message}`},{status:400});c=r}}let g=parseFloat(a||0)+parseFloat(o||0)+parseFloat(u||0),{data:m,error:f}=await p.p.from("granite_consignments").insert({consignment_number:t,supplier_id:s,arrival_date:n,payment_cash:parseFloat(a||0),payment_upi:parseFloat(o||0),transport_cost:parseFloat(u||0),total_expenditure:g,notes:l,status:"ACTIVE"}).select("*, supplier:granite_suppliers(id, name, contact_person)").single();if(f)return console.error("Database error:",f),i.NextResponse.json({error:`Database error: ${f.message}`},{status:400});return i.NextResponse.json(m,{status:201})}catch(e){return console.error("Server error:",e),i.NextResponse.json({error:`Server error: ${e instanceof Error?e.message:"Unknown error"}`},{status:500})}}async function c(e){try{let r=new URL(e.url).searchParams.get("id");if(!r)return i.NextResponse.json({error:"Consignment ID required"},{status:400});await p.p.from("granite_blocks").delete().eq("consignment_id",r);let{error:t}=await p.p.from("granite_consignments").delete().eq("id",r);if(t)return i.NextResponse.json({error:t.message},{status:400});return i.NextResponse.json({success:!0})}catch(e){return i.NextResponse.json({error:"Internal server error"},{status:500})}}let d=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/granite-consignments/route",pathname:"/api/granite-consignments",filename:"route",bundlePath:"app/api/granite-consignments/route"},resolvedPagePath:"/Users/bala/Downloads/granite-ledger-1/app/api/granite-consignments/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:m,serverHooks:f}=d,x="/api/granite-consignments/route";function _(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}},2632:(e,r,t)=>{let s;t.d(r,{p:()=>s});var n=t(2814);let a=process.env.SUPABASE_URL,o=process.env.SUPABASE_SERVICE_ROLE;a&&o?s=(0,n.eI)(a,o,{auth:{persistSession:!1}}):(console.warn("Missing Supabase environment variables. Using dummy client."),s={from:()=>({select:()=>({data:[],error:Error("Supabase not configured")}),insert:()=>({data:null,error:Error("Supabase not configured")}),update:()=>({data:null,error:Error("Supabase not configured")}),delete:()=>({data:null,error:Error("Supabase not configured")})})})}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[948,505],()=>t(9552));module.exports=s})();